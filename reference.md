# GCPドキュメントのまとめ

## Computing

### Compute Engine
- ストレージオプション
  - ゾーン永続HDD,SSD
  - リージョン永続HDD,SSD
    - リージョン内の2つのゾーンに同期レプリケーションされる
  - ローカルSSD
    - 一番スループットが高い
    - VM削除と同時に削除される想定のため、暗号化に対応していない
    - インスタンスあたりの最大容量は3TB
  - CloudStorage
  - Filestore

### App Engine
- Standard
  - 中でサンドボックス(コンテナ？)が動いてる
  - 0インスタンスにスケールできる
  - 数秒で起動する
  - 最後の処理から15分後、もしくはシャットダウンした15分後に課金が止まる
  - マシンタイプがある(Bシリーズ,Fシリーズ)
  - 使える言語
    - Python
    - Java
    - Node.js
    - PHP
    - Ruby
    - Go

- Frexible
  - 中でComputeEngineインスタンスが動いてる
    - つまり、SSHできる
  - 起動は数分かかる
  - CPU,メモリは任意で決めれる
  - 使える言語
    - Standard＋.NET
    - 独自のDockerイメージとかも使える

- 共通
  - アプリケーションのコンポーネント
    - アプリケーション
      - アプリを構成するサービス、バージョン、インスタンスのリソースを格納する最上位のコンテナ
      - 少なくとも1つのサービスを含む
    - サービス
      - マイクロサービスとして働く論理コンポーネント
    - バージョン
      - ロールバック用、テスト用、その他一次的いなイベント用といったアプリの各バージョンを素早く切り替えることが出来る
      - トラフィックを移行or分割して、特定のバージョンにトラフィックをルーティングすることもできる
    - インスタンス
      - AppEngineの最小単位
      - サービスに含まれる各バージョンはこのインスタンス上で実行される

### Kubernetes Engine
- クラスタ
  Kubernetesクラスターは、少なくとも1つのクラスタマスターとノードで構成される
  - クラスタマスター
    - Kubernetesのコントロールプレーンを実行する
    - クラスタの全ノードについて、ライフサイクル、スケーリング、アップグレードとかの管理をする
  - KubernetesAPI
    - クラスタの操作は、すべてKubernetesAPI呼び出しを経由して実行される
    - マスターは、KubernetesAPIサーバプロセスを実行してリクエストを処理する
    - 呼び出しは、HTTP/gRPCとか、kubectl、Consoleから操作できる
  - ノード
    - アプリケーションを実行するワーカーマシン
    - 個々のマシンはComputeEngineインスタンス
    - Dockerコンテナをサポートするサービスを自動で実行する
      - Dockerランタイム
      - Kubernetesノードエージェント(kubelet)
        - マスターと通信して、Dockerコンテナの起動と実行を行う
    - マシンタイプのデフォルトはe2-medium
      - クラスタ作成時に他のも指定できる
  - ノードの割り当て可能リソース
    いくつかのノードは、そのノードをクラスタの一部と機能させるためにGKEとKubernetesノードコンポーネントを実行する必要があるので、ノードのリソース数とGKEのノードに割り当て可能なリソース数が異なることがある
    以下の通り予約される
    - メモリ1GB未満:255MiBのメモリ
    - 最初の4GB:25%
    - 次の4GB(最大8GB):20%
    - 次の8GB(16GB):10%
    - 次の112GB(128GB):6%
    - 128GBを超えるメモリ:2%

- Serviceの種類
  - ClusterIP
    - 内部クライアントが内部の固定IPアドレスにリクエストを送信する
    - クラスタ内のクライアントが、特定のPodにアクセスする場合
  - NodePort
    - クライアントはServiceが指定した１つ以上のnodePort値を使用して、ノードのIPにリクエストを送信する
    - ClusterIPの拡張版
    - 外部クライアントは、クラスタノードの外部IPの、nodePortのポートでServiceを呼び出す
  - LoadBalancer
    - クライアントがネットワークロードバランサのIPにリクエストを送信する
    - NodePortの拡張版
    - 外部クライアントは、LBの外部IPでServiceを呼び出す
    - ポートはPorts:portの値
  - ExternalName
    - 内部クライアントが、外部DNS名のエイリアスとして、ServiceのDNS名を使用する
    - 内部クライアントがmy-xn-service.default.svc.cluster.localにアクセスすると、example.comにリダイレクトされる
    - ExternalNameタイプは特異で、一連のPodに関連付けられてないし固定IPがない
    - 内部DNS名から外部DNS名のマッピングに使われる
  - Headless
    - Podのグループ化を行うが、固定IPは必要ないときに使う


## Storage,Database

### Cloud Storage
- 可用性
  - Standard
    - Multi(Dual)-Regionで99.99%を超える
    - Regionalで99.99%
  - そのほか(Nearline,Coldline,Archive)
    - Multi(Dual)-Regionで99.95%
    - Regionalで99.90%

- すべてのクラス
  - 無制限ストレージ
  - 耐久性 99.999999999%
  - 地理的な冗長性

### Bigtable
- インスタンス
  - データのコンテナ
  - 1つ以上のクラスタを含む
  - ストレージタイプ
    - SSD or HDD
  - アプリプロファイル
    - レプリケーションを使う場合
    - アプリがインスタンスのクラスタにどのように接続するかを制御する
- クラスタ
  - 1インスタンス当たり4つまで含まれる
  - 各クラスタは別々のゾーンに配置される
  - 1つ以上のノードを含む
  - 1つの場合レプリケーションしない
  - 2つめを追加すると自動でレプリケーションを開始する
- ノード
  - 最小単位のコンピューティングリソース
  - Bigtableはバックグラウンドでテーブル内のすべてのデータを別々のタブレットに分割する
  - タブレットはノードと同じゾーンにあるディスクに、ノードとは別に格納される
  - タブレットは一つのノードに関連付けられる
  - ディスク上の特定のタブレットをトラッキングする
  - 受信するタブレットの読み書き処理をする
  - 定期的なコンパクションなどのメンテナンスタスクをタブレットで実行する

### Datastore(Firestore)
- ロケーションの種類
  - リージョン
  - マルチリージョン

- コンポーネント
  - 種類
    - RDBMSでいうテーブル
  - エンティティ
    - 行
  - プロパティ
    - 列
  - キー
    - 主キー

### Filestore
- いうたらNAS
- NFSv3に対応

### CLoud SQL

### CLoud Spanner
- インスタンス
  - インスタンスの構成
    - データベースの地理的な場所の定義
      - リージョン
      - マルチリージョン
    - レプリケーションの定義
  - ノード数
    - 選択したノード数により、そのインスタンスで利用可能なストレージ量が決まるｖ

## 負荷分散
- 負荷分散の種類
  1. 外部HTTP(S)
  2. 外部SSL Proxy
  3. 外部TCP Proxy
  4. 外部Network TCP/UDP
  5. 内部TCP/UDP
  6. 内部HTTP(S)

- 外部Network負荷分散
  - HTTPでもなく、TCPでもない(UDPの場合)は外部Network負荷分散を使うって感じのフローチャートやけど、HTTP負荷分散とTCP負荷分散ができないわけではない。
  - パススルー方式
  - →クライアントIPを保持する

- マネージドインスタンスグループ
  - 自動修復、負荷分散、自動スケーリング、自動更新、ステートフルなどの機能をサポート
  - 単一ゾーンまたはリージョンで作成できる
  - 自動修復
    VMベースでの自動修復は、インスタンスのステータスを常にRUNNING状態に維持する
    RUNNINGじゃないインスタンスは自動的に再作成される
    アプリケーションベースの自動修復にはヘルスチェックを使う
  - 自動更新
    MIG内のインスタンスに新しいバージョンのソフトウェアを安全にデプロイできる
  - ステートフルワークロード
    ステートフルMIGは、マシンの再起動、再作成、自動修復、更新時に、各インスタンス固有の状態(インスタンス名、永続ディスク、メタデータなど)を保持する 

- 非マネージドインスタンスグループ
  - 異種インスタンスをまとめる
  - スケーリングとか自動修復はできない
  - 同一ゾーン内のみしか作れない


## Networking

### VPC
- 共有VPC
  - 使用料金は、リソースが配置されているプロジェクトに請求される


## Serverless Computing

### Cloud Functions
- Cloud Functionsの料金は、関数の実行期間、関数の呼び出し回数、関数に対してプロビジョニングされたリソースの数に応じて決まる
  - 呼び出し回数
    - 最初の200万回は無料
    - 以降、100万単位で$0.4
  - 実行期間
    - 関数がリクエストを受け取ってから完了するまでの期間
    - 100ミリ秒単位で測定される
    - メモリとCPUの使用量でも変動する
      - メモリ:512MB,CPU:800MHz → $0.000000925　等


## セキュリティ アイデンティティ

### Cloud IAM 
- メンバー
  - Googleアカウント
  - サービスアカウント
  - Googleグループ
  - G Suite または Cloud Identity ドメイン

- ロール
  ロールは権限の集まり
  ユーザに直接権限を付与できず、代わりにロールを付与する(→ポリシーを設定する)
  - 基本ロール
    - オーナー
    - 編集者
    - 閲覧者
  - 事前定義のロール
    - roles/pubsub.publlisher 等
  - カスタムロール

- ポリシー
  ポリシーは、だれがどの種類のアクセス権を持つかを定義するステートメントの集まり
  ポリシーによって、ユーザにロールを付与できる
  - IAM Policy オブジェクト
    - Binding のリストで構成される
    - Binding メンバーのリストをロールにバインドする

- リソース階層
  - 組織
  - フォルダ
  - プロジェクト
  - リソース
  のレベルでポリシーを設定できる
  リソースが一番子の階層
  子のリソースは、親のリソースのポリシーから継承される
  つまり、リソースに対して有効なポリシーは、そのリソースに設定されたポリシーと、親リソースから継承されるポリシーの和集合である

## ハイブリッド

### Interconnect

#### 課金対象
- Dedicated Interconnect
  - 1時間当たりのVLANアタッチメント
  - 1か月当たりの回路（？）
  ```
  You're charged on a monthly basis for interconnects and on an hourly basis for interconnect attachments (VLANs).
  ```

- Partner Interconnect
  - 1か月あたりのVLANアタッチメント
  ```
  Google charges you on a monthly basis for interconnect attachments (VLANs).Your service provider might also charge you for services such as using their network, which isn't included in your GCP bills.
  ```

### Peering
- Googleのエッジネットワークと接続する
- エッジロケーションは現在142箇所　東京7箇所、大阪2箇所
- ダイレクトピアリングはGoogleCloudの外部にある
  - →よって、G Suiteへアクセスする必要がなければInterconnectを使う

- ダイレクトピアリング
  - 下り料金(Egress)は割引が適用されるが、プロジェクトごとに有効化する必要がある


## Cloud Billing
- 請求先アカウント
  - リソースの一つ
  - GCPを利用することで発生したすべての費用を追跡
  - 請求先アカウントごとに一つの請求書が作成される
  - 誰が支払いを行うかを定義する
  - お支払いプロファイルに関連付けられる

  - セルフサービスアカウント
  - 請求書発行アカウント

- 支払いプロファイル
  - 費用に対する支払い方法が記録されている
  - プロファイル管理者の名前住所納税者番号等の情報が保管される

- サブアカウント
  - 販売パートナー用に用意されるアカウント


## その他
- GoogleCloudのプロジェクトやリソースの管理方法
  - Console
  - Comand Line Interface(gcloud)
    - Cloud SDK
    - Cloud Shell
  - クライアントライブラリ(API)
    - Node.js や Python から呼び出す
  - Cloud Console モバイルアプリ
  - Cloud tools for PowerShell
    - Windowsサーバ用