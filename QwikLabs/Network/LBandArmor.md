# HTTP LoadBalancer with Cloud Armor

- HTTPとヘルスチェックのファイアウォールルールを作成する
- インスタンステンプレートを2つ作成
- MIGを2つ作成
- LBをIPv4,v6の2通り作成する
- ストレステストを実施する
- IPアドレスをブラックリストに登録してアクセス制限する

## HTTPとヘルスチェックのFWルール作成

ラボの通り作成する
LBからのヘルスチェックはGCPが指定しているIP範囲があるのでそれを参考に許可ルールを作成する

## インスタンステンプレート作成

自動スケーリングできるようにテンプレートを作成する
GCE作成みたいな感じでできる

## MIG作成

LBに実際にぶら下げるように指定するMIGを作成する
どんな条件でインスタンス数を増減させるか指定できる
今回はCPU80%使用で1~5台まで増減 クールダウンタイムは45秒
- クールダウン : インスタンスの起動からアプリが提供可能になるまでにようする時間
  - 300秒に設定したら、オートスケーラーが負荷予測の5分前にVM作成を始めてくれる

## LB作成

コンソールの手順通り作成する

### 接続確認

LBができたらIPアドレス入力して接続してみる
作成してから5分ほど404が帰ってくるけど、待ってたらOK

## siegeサーバ作成

SIEGEは負荷かけツールかな？
IP:34.73.174.233

siege -c 250 http://lbのアドレス
で負荷かけれる

LBのバックエンドを見ると、トラフィックが最初us-west1に流れて、
負荷が上がっていくとeurope-west1に行くのがわかる
    →LBの仕様で、デフォルトでは一番近いリージョンにトラフィックが流れるようになっている

## Armorでsiegeを拒否する

Armorのポリシーを作成していく
→なぜかターゲット設定でLBのバックグラウンドが指定できない

→解決
    Armorでターゲット指定するんじゃなくて、LBのバックエンドの設定からArmorのポリシーを選択する

## siegeサーバがアクセスできなくなっていることを確認

Loggingで、クエリに httploadbalancer → http-lb を選択
クエリ結果をどれか選んで展開
  - httpRequest で remoteIP が siegeサーバの外部IPであることを確認
  - jsonPayload : enforcedSecurityPolicy で denylist-siege によってDENYされていることを確認